{"version":3,"file":"auth-validator.mjs","sources":["../../../../../src/validators/auth-validator.ts"],"sourcesContent":["import { z } from \"zod\";\nimport { zValidator } from \"@hono/zod-validator\";\n\n// Checks if the provided site ID matches any of the allowed domain patterns\nconst isDomainAllowed = (siteID: string, allowedDomains: string) => {\n\tconst patterns = allowedDomains.split(\",\").map((p) => p.trim());\n\n\treturn patterns.some((pattern) => {\n\t\t// Escape special regex characters to treat them as literals (e.g. '.' becomes '\\.')\n\t\tconst escapedPattern = pattern.replace(/[.+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\n\n\t\t// Convert wildcard (*) to regex equivalent (.*) and anchor the pattern\n\t\t// This means *.example.com would match blog.example.com, store.example.com, etc\n\t\tconst regexPattern = `^${escapedPattern.replace(/\\*/g, \".*\")}$`;\n\n\t\t// Test if the site ID matches the current pattern\n\t\treturn new RegExp(regexPattern).test(siteID);\n\t});\n};\n\nconst authQuerySchema = z.object({\n\tprovider: z.enum([\"github\"], { message: \"The selected backend is not supported.\" }),\n\tsite_id: z.string(),\n\tscope: z.string(),\n});\n\n// Creates a validator middleware for authentication query parameters\nexport const authQueryValidator = (allowedDomains?: string) => {\n\treturn zValidator(\"query\", authQuerySchema, (result, c) => {\n\t\tif (!result.success) return c.text(result.error.issues[0].message, { status: 422 });\n\n\t\t// If allowedDomains is provided, perform domain access control checks\n\t\tconst siteID = result.data.site_id;\n\t\tif (allowedDomains && !isDomainAllowed(siteID, allowedDomains)) {\n\t\t\treturn c.text(\"Your domain is not authorized to use this authenticator.\", { status: 403 });\n\t\t}\n\t});\n};\n"],"names":["isDomainAllowed","siteID","allowedDomains","p","pattern","regexPattern","authQuerySchema","z","authQueryValidator","zValidator","result","c"],"mappings":";;AAIA,MAAMA,IAAkB,CAACC,GAAgBC,MACvBA,EAAe,MAAM,GAAG,EAAE,IAAI,CAACC,MAAMA,EAAE,MAAM,EAE9C,KAAK,CAACC,MAAY;AAMjC,QAAMC,IAAe,IAJED,EAAQ,QAAQ,sBAAsB,MAAM,EAI3B,QAAQ,OAAO,IAAI,CAAC;AAG5D,SAAO,IAAI,OAAOC,CAAY,EAAE,KAAKJ,CAAM;AAAA,CAC3C,GAGIK,IAAkBC,EAAE,OAAO;AAAA,EAChC,UAAUA,EAAE,KAAK,CAAC,QAAQ,GAAG,EAAE,SAAS,0CAA0C;AAAA,EAClF,SAASA,EAAE,OAAO;AAAA,EAClB,OAAOA,EAAE,OAAO;AACjB,CAAC,GAGYC,IAAqB,CAACN,MAC3BO,EAAW,SAASH,GAAiB,CAACI,GAAQC,MAAM;AAC1D,MAAI,CAACD,EAAO,QAAS,QAAOC,EAAE,KAAKD,EAAO,MAAM,OAAO,CAAC,EAAE,SAAS,EAAE,QAAQ,KAAK;AAG5E,QAAAT,IAASS,EAAO,KAAK;AAC3B,MAAIR,KAAkB,CAACF,EAAgBC,GAAQC,CAAc;AAC5D,WAAOS,EAAE,KAAK,4DAA4D,EAAE,QAAQ,KAAK;AAC1F,CACA;"}